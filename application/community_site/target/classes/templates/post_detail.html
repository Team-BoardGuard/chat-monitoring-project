<html layout:decorate="~{default_layout}">
<div layout:fragment="content" class="container my-3">
    <!-- Post Title -->
    <h2 class="border-bottom py-2" th:text="${post.title}"></h2>

    <!-- Post Content -->
    <div class="card my-3">
            <div class="card-body">
                <div class="card-text" style="white-space: pre-line;" th:text="${post.content}"></div>
                <div class="d-flex justify-content-end">
                    <div class="badge bg-light text-dark p-2 text-start mt-3">
                        <div th:text="${post.author != null ? post.author.username : 'N/A'}"></div>
                        <div th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')}"></div>
                    </div>
                </div>
                <div class="my-3">
                    <a href="javascript:void(0);" class="recommend btn btn-sm btn-outline-success" th:data-uri="@{|/post/vote/${post.id}|}">
                        추천
                        <span class="badge rounded-pill bg-success" th:text="${#lists.size(post.voter)}"></span>
                    </a>
                </div>
            </div>    </div>

    <!-- Action Buttons -->
    <div class="my-3">
        <a th:href="@{/post/list}" class="btn btn-secondary">목록</a>
        <a th:href="@{|/post/modify/${post.id}|}" class="btn btn-sm btn-outline-secondary"
           sec:authorize="isAuthenticated()" th:if="${post.author != null and #authentication.getPrincipal().getUsername() == post.author.username}">수정</a>
        <a href="javascript:void(0);" th:data-uri="@{|/post/delete/${post.id}|}" class="delete btn btn-sm btn-outline-danger"
           sec:authorize="isAuthenticated()" th:if="${post.author != null and #authentication.getPrincipal().getUsername() == post.author.username}">삭제</a>
    </div>

    <!-- Comments Section -->
    <div class="mt-4">
        <h5 class="border-bottom my-3 pb-2"><span th:text="${#lists.size(post.commentList)}"></span>개의 댓글</h5>

        <!-- Comment Form -->
        <form th:action="@{|/comment/create/${post.id}|}" th:object="${commentForm}" method="post" class="my-3">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div th:replace="form_errors :: formErrorsFragment"></div>
            <div class="input-group">
                <textarea sec:authorize="isAnonymous()" disabled class="form-control" rows="3"></textarea>
                <textarea sec:authorize="isAuthenticated()" th:field="*{content}" class="form-control" rows="3"></textarea>
                <button sec:authorize="isAuthenticated()" type="submit" class="btn btn-primary">댓글 등록</button>
            </div>
        </form>

        <!-- Comment List -->
        <div class="list-group">
            <div th:each="comment : ${post.commentList}" th:if="${comment.parent == null}" class="list-group-item list-group-item-action flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1" th:text="${comment.author.username}"></h6>
                    <small th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}"></small>
                </div>
                <p class="mb-1" th:text="${comment.content}"></p>
                <div>
                    <a href="javascript:void(0);" class="small reply" th:data-id="${comment.id}">답글</a>
                    <a th:href="@{|/comment/modify/${comment.id}|}" class="small text-decoration-none ms-2"
                       sec:authorize="isAuthenticated()" th:if="${comment.author != null and #authentication.getPrincipal().getUsername() == comment.author.username}">수정</a>
                    <a href="javascript:void(0);" th:data-uri="@{|/comment/delete/${comment.id}|}" class="delete small text-decoration-none ms-2"
                       sec:authorize="isAuthenticated()" th:if="${comment.author != null and #authentication.getPrincipal().getUsername() == comment.author.username}">삭제</a>
                </div>

                <!-- Replies -->
                <div th:each="reply : ${comment.children}" class="reply-item mt-3 ms-4">
                     <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1" th:text="${reply.author.username}"></h6>
                        <small th:text="${#temporals.format(reply.createDate, 'yyyy-MM-dd HH:mm')}"></small>
                    </div>
                    <p class="mb-1" th:text="${reply.content}"></p>
                    <div>
                        <a th:href="@{|/comment/modify/${reply.id}|}" class="small text-decoration-none"
                           sec:authorize="isAuthenticated()" th:if="${reply.author != null and #authentication.getPrincipal().getUsername() == reply.author.username}">수정</a>
                        <a href="javascript:void(0);" th:data-uri="@{|/comment/delete/${reply.id}|}" class="delete small text-decoration-none ms-2"
                           sec:authorize="isAuthenticated()" th:if="${reply.author != null and #authentication.getPrincipal().getUsername() == reply.author.username}">삭제</a>
                    </div>
                </div>
                <!-- Hidden Reply Form -->
                <div class="reply-form-container mt-2" th:id="|reply-form-${comment.id}|" style="display: none;">
                    <form th:action="@{|/comment/create/${post.id}|}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="hidden" name="parentId" th:value="${comment.id}">
                        <div class="input-group">
                            <textarea name="content" class="form-control" rows="2"></textarea>
                            <button type="submit" class="btn btn-sm btn-outline-primary">답글 등록</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
<script layout:fragment="script" type='text/javascript'>
// Delete confirmation
const delete_elements = document.getElementsByClassName("delete");
Array.from(delete_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("정말로 삭제하시겠습니까?")) {
            location.href = this.dataset.uri;
        };
    });
});

// Recommendation confirmation
const recommend_element = document.querySelector(".recommend");
recommend_element.addEventListener('click', function() {
    if(confirm("이 글을 추천하시겠습니까?")) {
        location.href = this.dataset.uri;
    };
});

// Reply form toggle
const reply_elements = document.getElementsByClassName("reply");
Array.from(reply_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        const form = document.getElementById(`reply-form-${this.dataset.id}`);
        form.style.display = (form.style.display === 'none') ? 'block' : 'none';
    });
});
</script>
</html>